<?xml version="1.0" encoding="UTF-8"?>
<!--
  Licensed Materials - Property of IBM

  Copyright IBM Corporation 2012,2013. All Rights Reserved.

  US Government Users Restricted Rights - Use, duplication or disclosure
  restricted by GSA ADP Schedule Contract with IBM Corp.
-->
<!--

  This is the ant file building an EAR file.

-->
<project name="app_buildEAR" default="main">

  <import file="./app_properties.xml" />

  <import file="./app_utilities.xml" />

  <import file="./app_macros.xml" />

  <!-- For WAS and WLS -->
  <property name="sde.lib.list" value="coreinf.jar
                                       ehcache-core-${version-ehcache-core}.jar
                                       profiler-core.jar
                                       slf4j-api-${version-slf4j-api}.jar
                                       slf4j-jdk14-${version-slf4j-jdk14}.jar
                                       rules.jar
                                       rules_debugger.jar
                                       jde-commons.jar
                                       appinf.jar
                                       appinf_internal.jar
                                       gss.jar
                                       guice-${version-guice}.jar
                                       guice-assistedinject-${version-guice-assistedinject}.jar
                                       guice-multibindings-${version-guice-multibindings}.jar
                                       guice-throwingproviders-${version-guice-throwingproviders}.jar
                                       aopalliance.jar
                                       JSON4J_Apache.jar
                                       jdom-${version-jdom}.jar
                                       log4j-${version-log4j}.jar
                                       icu4j-${version-icu4j}.jar
                                       castor-xml-${version-castor}.jar
                                       xalan-${version-xalan}.jar
                                       serializer-${version-serializer}.jar
                                       xerces-${version-xerces}.jar
                                       commons-pool-${version-commons-pool}.jar
                                       commons-codec-${version-commons-codec}.jar
                                       commons-dbcp-${version-commons-dbcp}.jar
                                       commons-discovery-${version-commons-discovery}.jar
                                       commons-logging-${version-commons-logging}.jar
                                       commons-collections-${version-commons-collections}.jar
                                       commons-beanutils-${version-commons-beanutils}.jar
                                       commons-digester-${version-commons-digester}.jar
                                       commons-validator-${version-commons-validator}.jar
                                       commons-lang-${version-commons-lang}.jar
                                       compass.jar
                                       lucene-core-${version-lucene-core}.jar
                                       lucene-analyzers-${version-lucene-analyzers}.jar
                                       wsdl4j-${version-wsdl4j}.jar
                                       axis-${version-axis}.jar
                                       java_cup-${version-java_cup}.jar
                                       antlr-${version-antlr}.jar
                                       wss4j-${version-wss4j}.jar
                                       xmlsec-${version-xmlsec}.jar
                                       bcel-${version-bcel}.jar"/>

  <property name="app.lib.list" value="properties.jar
                                       application.jar
                                       codetable.jar
                                       messages.jar
                                       message_properties.jar
                                       events.jar
                                       struct.jar
                                       implementation.jar
                                       wsc-proxy.jar
                                       axis2-wsc-proxy.jar"/>

  <property name="dd.type" value=""/>
  <property name="wls.lib.dir" value="${WLS_HOME}/lib"/>
  <path id="sde.class.path">
    <fileset dir="${dir.sde.lib}">
      <include name="*.jar"/>
    </fileset>
  </path>


  <property file="${app.prop.location}"/>

  <!-- By default the run as username is SYSTEM. -->
  <!-- This can be overwritten in AppServer.properties. -->
  <property name="runas.user"     value="SYSTEM"/>

  <target name="get.appserver">
    <condition property="isWAS">
      <equals arg1="${dd.type}" arg2="WAS"/>
    </condition>
    <condition property="isWLS">
      <equals arg1="${dd.type}" arg2="WLS"/>
    </condition>


    <!-- Populate the appropriate vendor name -->
    <condition property="vendor.name" value="IBM">
      <equals arg1="${dd.type}" arg2="WAS"/>
    </condition>
    <condition property="vendor.name" value="BEA">
      <equals arg1="${dd.type}" arg2="WLS"/>
    </condition>
    <property name="vendor.name" value="" />

  </target>

  <target name="set.build.facade">
    <condition property="build.facade">
      <resourcecount when="greater" count="0">
        <fileset dir="${dir.bld.svr.gen}">
          <include name="${project.package}/**/remote/*Bean.java"/>
        </fileset>
      </resourcecount>
    </condition>
  </target>

  <macrodef name="deleteFromZip">
    <attribute name="zip"/>
    <element name="members"
           implicit="true"
           optional="true"/>
    <sequential>
      <mkdir dir="__tmp__"/>
      <unzip dest="__tmp__" src="@{zip}"/>
      <delete file="@{zip}"/>
      <delete>
        <fileset dir="__tmp__">
          <members/>
        </fileset>
      </delete>
      <zip destfile="@{zip}"
           basedir="__tmp__"/>
      <delete dir="__tmp__"/>
    </sequential>
  </macrodef>

  <!--  *****************  -->
  <!--  ***  M A I N  ***  -->
  <!--  *****************  -->
  <target name="main" description="Builds ear file" depends="get.appserver, set.build.facade">
    <antcall target="dispmsg" inheritall="false">
      <param name="prm.msg" value="Starting buildEAR"/>
    </antcall>

    <!-- Check to see if the AppServer.properties file exists -->
    <echo message="Using properties file '${app.prop.location}'."/>
    <condition property="appserver.properties.exists">
      <available file="${app.prop.location}" type="file"/>
    </condition>
    <antcall target="check.properties.exists"/>

    <delete dir="${dir.ear.tmp}"/>
    <delete dir="${dir.ear}/WAS/META-INF"/>
    <delete dir="${dir.ear}/WLS/META-INF"/>
    <delete dir="${dir.ear.combined}"/>

    <mkdir dir="${dir.ear.tmp}"/>
    <mkdir dir="${dir.ear.combined}"/>
    <mkdir dir="${dir.ear.combined}/META-INF"/>
    <mkdir dir="${dir.ear.extrajars}"/>
    <mkdir dir="${dir.ear}/${dd.type}"/>

    <taskdef name="handleclasspath" classname="curam.util.tools.AntHandleOptionalClassPath"
      classpath="${jar.tools}:${jar.coreinf}"/>

    <handleclasspath to="manipulated.preclasspath"  from="${sysenv.PRE_CLASSPATH}"  outDir="${dir.ear.extrajars}"/>

    <handleclasspath to="manipulated.component.classpath"  outDir="${dir.ear.extrajars}">
      <fileset dir="${base.dir}/components">
        <include name="*/lib/**/*.jar"/>
      </fileset>
    </handleclasspath>

    <handleclasspath to="manipulated.postclasspath" from="${sysenv.POST_CLASSPATH}" outDir="${dir.ear.extrajars}"/>

    <available file="${jar.wsc.proxy}"  type="file" property="wsc.proxy.present"  value="wsc-proxy.jar" />
    <property name="wsc.proxy.present"  value=""/>
    <available file="${jar.axis2.wsc.proxy}"  type="file" property="wsc2.proxy.present"  value="axis2-wsc-proxy.jar" />
    <property name="wsc2.proxy.present"  value=""/>

    <manifest file="${dir.ear.tmp}/Manifest.mf">
      <attribute name="Class-Path" value="
        ${manipulated.preclasspath}
        application.jar
        implementation.jar
        codetable.jar
        messages.jar
        message_properties.jar
        properties.jar
        struct.jar
        events.jar
        ${wsc.proxy.present}
        ${wsc2.proxy.present}
        ${manipulated.component.classpath}
        appinf.jar
        appinf_internal.jar
        gss.jar
        coreinf.jar
        ehcache-core-${version-ehcache-core}.jar
        profiler-core.jar
        slf4j-api-${version-slf4j-api}.jar
        slf4j-jdk14-${version-slf4j-jdk14}.jar
        rules.jar
        rules_debugger.jar
        jde-commons.jar
        guice-${version-guice}.jar
        guice-assistedinject-${version-guice-assistedinject}.jar
        guice-multibindings-${version-guice-multibindings}.jar
        guice-throwingproviders-${version-guice-throwingproviders}.jar
        aopalliance.jar
        JSON4J_Apache.jar
        jdom-${version-jdom}.jar
        log4j-${version-log4j}.jar
        icu4j-${version-icu4j}.jar
        commons-pool-${version-commons-pool}.jar
        commons-codec-${version-commons-codec}.jar
        commons-discovery-${version-commons-discovery}.jar
        commons-logging-${version-commons-logging}.jar
        commons-collections-${version-commons-collections}.jar
        commons-beanutils-${version-commons-beanutils}.jar
        commons-digester-${version-commons-digester}.jar
        commons-validator-${version-commons-validator}.jar
        commons-lang-${version-commons-lang}.jar
        commons-dbcp-${version-commons-dbcp}.jar
        compass.jar

        lucene-core-${version-lucene-core}.jar
        lucene-analyzers-${version-lucene-analyzers}.jar
        wsdl4j-${version-wsdl4j}.jar
        axis-${version-axis}.jar
        java_cup-${version-java_cup}.jar
        antlr-${version-antlr}.jar
        castor-xml-${version-castor}.jar
        xalan-${version-xalan}.jar
        serializer-${version-serializer}.jar
        xerces-${version-xerces}.jar
        wss4j-${version-wss4j}.jar
        xmlsec-${version-xmlsec}.jar
        bcel-${version-bcel}.jar
      ${sde.lib.axis2.list}
      ${sde.lib.axis2.rampart.list}
      ${manipulated.postclasspath}"/>
      <section name="common">
        <attribute name="Specification-Title"   value="CuramSDEJ"/>
        <attribute name="Specification-Vendor"  value="IBM Corporation"/>
      </section>
    </manifest>

    <echo message="Building the component pieces of ${SERVER_MODEL_NAME}.ear..."/>

    <copy toDir="${dir.ear}/WAS/META-INF">
      <fileset dir="${dir.templates}">
        <include name="*.xml"/>
        <include name="*.mf"/>
        <include name="*.policy"/>
        <exclude name="application-j2ee-engine.xml"/>
        <exclude name="jms-resources.xml"/>
        <exclude name="data-sources*.xml"/>
      </fileset>
    </copy>

    <copy toDir="${dir.ear}/WLS/META-INF">
      <fileset dir="${dir.templates}">
        <include name="*.xml"/>
        <include name="*.mf"/>
        <include name="*.policy"/>
        <exclude name="application-j2ee-engine.xml"/>
        <exclude name="jms-resources.xml"/>
        <exclude name="data-sources*.xml"/>
      </fileset>
    </copy>

    <available property="multiple.clients.required" file="${deployment.packaging.file}" />

    <copy toDir="${dir.ear}/Multiple">
      <fileset dir="${dir.ear}/${dd.type}" includes="META-INF/*" excludes="META-INF/app-Manifest.mf"/>
    </copy>

    <echo message="org.apache.commons.logging.LogFactory=org.apache.commons.logging.impl.LogFactoryImpl"
          file="${dir.ear.combined}/commons-logging.properties"/>


    <!-- Server needs to be generated before the client as it is used in multiple EAR files -->
    <antcall target="generate.server"/>

    <antcall target="generate.client"/>

  <condition property="prop.standard.ear.build">
    <or>
      <istrue value="${server.only}"/>
    <not><isset property="multiple.clients.required"></isset></not>
      </or>
    </condition>

    <antcall target="create.standard.ear"/>

    <!-- delete temp -->
    <delete dir="${dir.ear.tmp}"/>
    <delete dir="${dir.ear.combined}"/>
    <delete dir="${dir.ear}/WAS/META-INF"/>
    <delete dir="${dir.ear}/WLS/META-INF"/>
    <delete dir="${dir.ear}/Multiple"/>

  </target>

  <target name="create.standard.ear" if="prop.standard.ear.build">

    <copy toDir="${dir.ear.combined}">
      <fileset dir="${dir.ear}/${dd.type}" includes="META-INF/*" excludes="META-INF/app-Manifest.mf"/>
    </copy>

    <replace dir="${dir.ear.combined}/META-INF">
      <include name="application.xml"/>
      <replacefilter token="@PROJECTNAME@" value="${SERVER_MODEL_NAME}"/>
      <replacefilter token="@EJB_MODULE@" value=""/>
      <replacefilter token="@WEB_MODULE@" value=""/>
      <replacefilter token="@HELP_MODULE@" value=""/>
      <replacefilter token="@SEARCH_MODULE@" value=""/>
      <replacefilter token="@INFRASTRUCTURE_MODULE@" value=""/>
      <replacefilter token="@FACADE_MODULE@" value=""/>
    </replace>

    <replace dir="${dir.ear.combined}/META-INF">
      <include name="weblogic-application.xml"/>
      <replacefilter token="@EJB_MODULE@" value=""/>
      <replacefilter token="@WEB_MODULE@" value=""/>
      <replacefilter token="@HELP_MODULE@" value=""/>
      <replacefilter token="@SEARCH_MODULE@" value=""/>
      <replacefilter token="@INFRASTRUCTURE_MODULE@" value=""/>
      <replacefilter token="@FACADE_MODULE@" value=""/>
    </replace>

    <replace dir="${dir.ear.combined}/META-INF">
      <include name="ibm-application-ext.xmi"/>
      <replacefilter token="@EJB_MODULE@" value=""/>
      <replacefilter token="@INFRASTRUCTURE_MODULE@" value=""/>
      <replacefilter token="@FACADE_MODULE@" value=""/>
      <replacefilter token="@SEARCH_MODULE@" value=""/>
    </replace>

    <replace dir="${dir.ear.combined}">
      <include name="jms*.xml"/>
      <replacefilter token="@APPLICATION_NAME@" value="${SERVER_MODEL_NAME}"/>
    </replace>

    <antcall target="create.single.ear">
      <param name="ear.name"          value="${SERVER_MODEL_NAME}"/>
      <param name="source.directory"  value="${dir.ear.combined}"/>
      <param name="appxml"            value="${dir.ear.combined}/META-INF/application.xml"/>
    </antcall>

  </target>

  <target name="create.single.ear">

    <delete file="${dir.ear}/${dd.type}/${ear.name}.ear"/>
    <ear
      destfile="${dir.ear}/${dd.type}/${ear.name}.ear"
      appxml="${appxml}"
      manifest="${dir.templates}/app-Manifest.mf"
      basedir="${source.directory}" duplicate="preserve">
    </ear>

  </target>

  <target name="generate.client" unless="server.only">
    <antcall target="generate.multiple.client"/>
    <antcall target="generate.single.client"/>
  </target>

  <target name="generate.multiple.client" if="multiple.clients.required">

    <delete dir="${client.dir}/build/clients"/>
    <mkdir dir="${client.dir}/build/clients"/>

    <taskdef name="clientcopy"
      classname="curam.util.tools.AntClientCopy"
      classpath="${jar.tools}:${jar.coreinf}:${jar.jdom}:${jar.commons}:${jar.guice}:
                 ${jar.aopalliance}:${jar.guice-assistedinject}:
                 ${jar.guice-multibindings}:${jar.guice-throwingproviders}"/>

    <clientcopy
      clientdir="${client.dir}"
      deploymentconfig="${deployment.packaging.file}"
      locales="${sysenv.LOCALE_LIST}"
      outdir="${client.dir}/build/clients">
    </clientcopy>

    <subant verbose="true" target="looped.client.build" inheritall="false" genericantfile="${dir.sde.bin}/app_buildEAR.xml">
      <dirset dir="${client.dir}/build/clients" includes="*"/>
    </subant>

  </target>

  <!--  *****************************  -->
  <!--  ***  LOOPED.CLIENT.BUILD  ***  -->
  <!--  *****************************  -->
  <target name="looped.client.build" depends="get.appserver">
    <delete dir="${dir.ear.client}"/>
    <mkdir dir="${dir.ear.client}"/>
    <mkdir dir="${basedir}/components/core"/>

    <loadproperties srcFile="${basedir}/deployment.properties"/>

    <delete dir="${dir.ear}/${ear.name}"/>
    <mkdir dir="${dir.ear}/${ear.name}"/>

    <!-- Default to a fresh copy, this is overriden by
         the server versions if this module includes the server -->
    <copy toDir="${dir.ear}/${ear.name}">
      <fileset dir="${dir.ear}/Multiple" includes="META-INF/*" excludes="META-INF/app-Manifest.mf, META-INF/LoginModuleConfiguration.xml"/>
    </copy>

    <property name="filtered.files"
      value="**/application.xml,**/web.xml,**/weblogic-application.xml,**/weblogic-ejb-jar.xml" />

    <!-- Copy all the required files except those that will be filtered. -->
    <copy todir="${dir.ear.client}">
      <fileset dir="${dir.cde.ear}/common" excludes="${filtered.files}" />
      <fileset dir="${dir.cde.ear}/${dd.type}" excludes="${filtered.files}" />
    </copy>

    <!-- Move all curam-config.deployment to curam-config.xml files. -->
    <move todir="${basedir}/components" overwrite="true">
      <fileset dir="${basedir}/components">
        <include name="*/curam-config.deployment"/>
      </fileset>
      <mapper type="glob" from="*.deployment" to="*.xml"/>
    </move>

    <condition property="looped.server.required">
       <istrue value="${ear.requireServer}"/>
    </condition>
    <condition property="looped.server.required.multi">
       <istrue value="${ear.multi.requireServer}"/>
    </condition>

    <antcall target="append.to.ApplicationConfiguration"/>
    <property name="ear.component.order" value=" "/>

    <exec executable="cmd.exe"
      dir="${client.dir}"
      osfamily="windows"
      failonerror="true">
      <arg line="/c call"/>
      <arg line="${client.dir}/build.bat"/>
      <arg line="client"/>
      <env key="ANT_CMD_LINE_ARGS"      value=""/>
      <env key="CLIENT_DIR"             path="${basedir}"/>
      <env key="CLIENT_COMPONENT_ORDER" value="${ear.component.order}"/>
      <env key="SKIP_ENV"               value="TRUE"/>
    </exec>

    <exec executable="${client.dir}/build.sh"
      dir="${client.dir}"
      osfamily="unix"
      failonerror="true">
      <arg line="client"/>
      <env key="CLIENT_DIR"             path="${basedir}"/>
      <env key="CLIENT_COMPONENT_ORDER" value="${ear.component.order}"/>
      <env key="SKIP_ENV"               value="TRUE"/>
    </exec>

    <!-- Is the Server Required -->
    <antcall target="looped.server.build"/>

    <!-- Load web.xml configuration settings generated from client build.
         These will be used in the following filter.
      -->
    <loadfile property="init.params.text"
              srcFile="${basedir}/build/web-init-params.xml"/>

    <copy todir="${dir.ear.client}">
      <fileset dir="${dir.cde.ear}/common" includes="${filtered.files}" />
      <fileset dir="${dir.cde.ear}/${dd.type}" includes="${filtered.files}" />
      <filterset>
        <filter token="APP_NAME"           value="${SERVER_MODEL_NAME}" />
        <filter token="SERVER"             value="localhost" />
        <filter token="PORT"               value="${curam.server.port}" />
        <filter token="LOCALE_INIT_PARAMS" value="${init.params.text}" />
      </filterset>
    </copy>

    <!-- Copy the web.xml from the override directory if it exists. -->
    <available property="customWebXml" file="${ear.custom.web.xml}/web.xml" />
    <antcall target="copy.customWebXml">
      <param name="web.xml.temp.location" value="${dir.ear.client}/war/WEB-INF"/>
      <param name="web.xml.override.location" value="${ear.custom.web.xml}"/>
    </antcall>

    <mkdir dir="${dir.ear.client}/war/WEB-INF/lib" />
    <echo file="${basedir}/WebContent/WEB-INF/classes/curam/omega3/ApplicationConfiguration.properties"
      append="true">${line.separator}vendor=${dd.type}${line.separator}</echo>

    <jar destfile="${dir.ear.client}/war/WEB-INF/lib/${SERVER_MODEL_NAME}_classes.jar">
      <fileset dir="${basedir}/WebContent/WEB-INF/classes" />
    </jar>
    <!-- Once we have copied all files into the ClientModule.war file, we then need to extract out the
    contents of the 1_struct.jar file. This is due to the fact we do not know how this jar may be loaded.
    It will depend on the system. Therefore, by extracting the contents and putting the class files in the
    web-inf/classes directory, the classes in this struct.jar file that may contain customized classes
    are guaranteed to take precedence. -->
    <unzip src="${basedir}/WebContent/WEB-INF/lib/1_struct.jar"
           dest="${basedir}/WebContent/WEB-INF/lib/temp_1_struct/WEB-INF/classes"/>

    <jar destfile="${dir.ear}/${ear.name}/ClientModule.war">
      <fileset dir="${basedir}/WebContent">
        <exclude name="WEB-INF/classes/**" />
        <exclude name="WEB-INF/lib/${CLIENT_PROJECT_NAME}_classes.jar" />
        <exclude name="**/*.xmi" />
        <exclude name="**/web.xml" />
        <exclude name="WEB-INF/lib/temp_1_struct/**"/>
        <exclude name="WEB-INF/lib/1_struct.jar"/>
      </fileset>
      <!-- include the expanded 1_struct.jar contents -->
      <fileset dir="${basedir}/WebContent/WEB-INF/lib/temp_1_struct"/>
      <fileset dir="${dir.ear.client}/war" />
    </jar>
    <!-- delete the temp directory -->
    <delete dir="${basedir}/WebContent/WEB-INF/lib/temp_1_struct"/>

    <replace dir="${dir.ear}/${ear.name}/META-INF">
      <include name="application.xml"/>
      <replacefilter
        token="@WEB_MODULE@"
        value="&lt;module id=&quot;WebModule_ClientModule&quot;&gt;&lt;web&gt;&lt;web-uri&gt;ClientModule.war&lt;/web-uri&gt;&lt;context-root&gt;${ear.context.root}&lt;/context-root&gt;&lt;/web&gt;&lt;/module&gt;"/>
    </replace>

    <replace dir="${dir.ear}/${ear.name}/META-INF">
      <include name="weblogic-application.xml"/>
      <replacefilter
        token="@WEB_MODULE@"
        value="&lt;module-ref&gt;&lt;module-uri&gt;${ear.context.root}&lt;/module-uri&gt;&lt;/module-ref&gt;"/>
    </replace>

    <antcall target="create.invalidation.module">
      <param name="dd.directory"     value="${dir.ear}/${ear.name}/META-INF"/>
      <param name="output.directory" value="${dir.ear}/${ear.name}"/>
    </antcall>

    <replace dir="${dir.ear}/${ear.name}/META-INF">
      <include name="application.xml"/>
      <replacefilter token="@PROJECTNAME@" value="${ear.name}"/>
      <replacefilter token="@EJB_MODULE@" value=""/>
      <replacefilter token="@WEB_MODULE@" value=""/>
      <replacefilter token="@HELP_MODULE@" value=""/>
      <replacefilter token="@SEARCH_MODULE@" value=""/>
      <replacefilter token="@INFRASTRUCTURE_MODULE@" value=""/>
      <replacefilter token="@FACADE_MODULE@" value=""/>
    </replace>

    <replace dir="${dir.ear}/${ear.name}/META-INF">
      <include name="weblogic-application.xml"/>
      <replacefilter token="@EJB_MODULE@" value=""/>
      <replacefilter token="@WEB_MODULE@" value=""/>
      <replacefilter token="@HELP_MODULE@" value=""/>
      <replacefilter token="@SEARCH_MODULE@" value=""/>
      <replacefilter token="@INFRASTRUCTURE_MODULE@" value=""/>
      <replacefilter token="@FACADE_MODULE@" value=""/>
    </replace>

    <replace dir="${dir.ear}/${ear.name}/META-INF">
      <include name="ibm-application-ext.xmi"/>
      <replacefilter token="@EJB_MODULE@" value=""/>
      <replacefilter token="@INFRASTRUCTURE_MODULE@" value=""/>
      <replacefilter token="@FACADE_MODULE@" value=""/>
      <replacefilter token="@SEARCH_MODULE@" value=""/>
    </replace>

    <replace dir="${dir.ear.combined}">
      <include name="jms*.xml"/>
      <replacefilter token="@APPLICATION_NAME@" value="${SERVER_MODEL_NAME}"/>
    </replace>

    <antcall target="create.single.ear">
      <param name="ear.name"          value="${ear.name}"/>
      <param name="source.directory"  value="${dir.ear}/${ear.name}"/>
      <param name="appxml"            value="${dir.ear}/${ear.name}/META-INF/application.xml"/>
    </antcall>

    <delete dir="${dir.ear}/${ear.name}"/>
    <delete dir="${dir.ear.client}"/>

  </target>

  <target name="append.to.ApplicationConfiguration" unless="looped.server.required">
    <echo file="${basedir}/JavaSource/curam/omega3/ApplicationConfiguration.properties"
      append="true">
dynamicUIMInitModelOnStart=false
    </echo>

  </target>


  <target name="looped.server.build"
    if="looped.server.required" >

    <antcall target="looped.server.build.single"/>
    <antcall target="looped.server.build.multi"/>
    <copy toDir="${dir.ear}/${ear.name}" overwrite="true">
      <fileset dir="${dir.ear}/${dd.type}" includes="META-INF/*" excludes="META-INF/app-Manifest.mf"/>
    </copy>

  </target>

  <target name="looped.server.build.single" unless="looped.server.required.multi">
    <mkdir dir="${dir.ear}/${ear.name}" />
    <move todir="${dir.ear}/${ear.name}">
      <fileset dir="${dir.ear.combined}">
        <include name="**/*.jar"/>
      </fileset>
    </move>
  </target>
  <target name="looped.server.build.multi" if="looped.server.required.multi">
    <mkdir dir="${dir.ear}/${ear.name}" />
    <copy todir="${dir.ear}/${ear.name}">
      <fileset dir="${dir.ear.combined}">
        <include name="**/*.jar"/>
      </fileset>
    </copy>
  </target>





  <!--  ************************************  -->
  <!--  ***  CREATE.INVALIDATION.MODULE  ***  -->
  <!--  ************************************  -->
  <target name="create.invalidation.module">

    <replace dir="${dd.directory}">
      <include name="ibm-application-ext.xmi"/>
      <replacefilter
        token="@EJB_MODULE@"
        value="&lt;moduleExtensions xmi:type=&quot;applicationext:EjbModuleExtension&quot; xmi:id=&quot;EjbModule_InvalidationModule&quot; altRoot=&quot;ALT-INF/InvalidationModule.jar&quot;&gt;
        &lt;module xmi:type=&quot;application:EjbModule&quot; href=&quot;META-INF/application.xml#EjbModule_InvalidationModule&quot;/&gt;
      &lt;/moduleExtensions&gt;"/>
    </replace>

    <replace dir="${dd.directory}">
      <include name="application.xml"/>
      <replacefilter
        token="@EJB_MODULE@"
        value="&lt;module id=&quot;EjbModule_InvalidationModule&quot;&gt;&lt;ejb&gt;InvalidationModule.jar&lt;/ejb&gt;&lt;/module&gt;"/>
    </replace>

    <replace dir="${dd.directory}">
      <include name="weblogic-application.xml"/>
      <replacefilter
        token="@EJB_MODULE@"
        value="&lt;module-ref&gt;&lt;module-uri&gt;InvalidationModule.jar&lt;/module-uri&gt;&lt;/module-ref&gt;"/>
    </replace>

    <antcall target="client.substitute.run.as"/>

    <jar destfile="${output.directory}/InvalidationModule.jar">
      <fileset dir="${dir.ear.client}/ejb-jar" />
    </jar>

  </target>

  <!--  *** Substitute with the 'runas.user' property, if specified. Else default to SYSTEM -->
  <target name="client.substitute.run.as">
     <replace file="${dir.ear.client}/ejb-jar/META-INF/weblogic-ejb-jar.xml"
        token="$RUN_AS_USER_NAME$" value="${runas.user}"/>
  </target>


  <!--  ********************************  -->
  <!--  ***  GENERATE.SINGLE.CLIENT  ***  -->
  <!--  ********************************  -->
  <target name="generate.single.client" unless="multiple.clients.required">

    <delete dir="${dir.ear.client}"/>
    <mkdir dir="${dir.ear.client}"/>

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="application.xml"/>
      <replacefilter
        token="@WEB_MODULE@"
        value="&lt;module id=&quot;WebModule_ClientModule&quot;&gt;&lt;web&gt;&lt;web-uri&gt;ClientModule.war&lt;/web-uri&gt;&lt;context-root&gt;/${CLIENT_PROJECT_NAME}&lt;/context-root&gt;&lt;/web&gt;&lt;/module&gt;"/>
    </replace>

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="weblogic-application.xml"/>
      <replacefilter
        token="@WEB_MODULE@"
        value="&lt;module-ref&gt;&lt;module-uri&gt;/${CLIENT_PROJECT_NAME}&lt;/module-uri&gt;&lt;/module-ref&gt;"/>
    </replace>

    <property name="filtered.files"
      value="**/application.xml,**/web.xml,**/weblogic-application.xml,**/weblogic-ejb-jar.xml" />

    <!-- Copy all the required files except those that will be filtered. -->
    <copy todir="${dir.ear.client}">
      <fileset dir="${dir.cde.ear}/common" excludes="${filtered.files}" />
      <fileset dir="${dir.cde.ear}/${dd.type}" excludes="${filtered.files}" />
    </copy>

    <!-- Load web.xml configuration settings generated from client build.
         These will be used in the following filter.  -->
    <loadfile property="init.params.text" srcFile="${client.dir}/build/web-init-params.xml"/>

    <!-- Copy all the files that will be filtered and apply the filter -->
    <copy todir="${dir.ear.client}">
      <fileset dir="${dir.cde.ear}/common" includes="${filtered.files}" />
      <fileset dir="${dir.cde.ear}/${dd.type}" includes="${filtered.files}" />
      <filterset>
        <filter token="APP_NAME"           value="${SERVER_MODEL_NAME}" />
        <filter token="SERVER"             value="localhost" />
        <filter token="PORT"               value="${curam.server.port}" />
        <filter token="LOCALE_INIT_PARAMS" value="${init.params.text}" />
      </filterset>
    </copy>

    <antcall target="create.invalidation.module">
      <param name="dd.directory"     value="${dir.ear}/${dd.type}/META-INF"/>
      <param name="output.directory" value="${dir.ear.combined}"/>
    </antcall>

    <!-- Copy the web.xml from the override directory if it exists. -->
    <available property="customWebXml" file="${client.dir}/project/ear/${dd.type}/web.xml" />
    <antcall target="copy.customWebXml">
      <param name="web.xml.temp.location" value="${dir.ear.client}/war/WEB-INF"/>
      <param name="web.xml.override.location" value="${client.dir}/project/ear/${dd.type}"/>
    </antcall>

    <jar destfile="${dir.ear.combined}/ClientModule.war">
      <fileset dir="${client.dir}/WebContent">
        <exclude name="WEB-INF/classes/**" />
        <exclude name="**/*.xmi" />
        <exclude name="**/web.xml" />
      </fileset>
      <fileset dir="${dir.ear.client}/war" />
    </jar>
    <delete dir="${dir.ear.client}"/>
  </target>


  <!-- Copy the web.xml from the override directory if it exists and apply
       filterset.
    -->
  <target name="copy.customWebXml" if="customWebXml">
    <copy todir="${web.xml.temp.location}" overwrite="true">
      <fileset dir="${web.xml.override.location}" includes="web.xml" />
      <filterset>
        <filter token="APP_NAME"           value="${SERVER_MODEL_NAME}" />
        <filter token="SERVER"             value="localhost" />
        <filter token="PORT"               value="${curam.server.port}" />
        <filter token="LOCALE_INIT_PARAMS" value="${init.params.text}" />
      </filterset>
    </copy>
  </target>

  <!--  ***************************************  -->
  <!--  ***  G E N E R A T E   S E R V E R  ***  -->
  <!--  ***************************************  -->
  <target name="generate.server" unless="client.only">

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="application.xml"/>
      <replacefilter
        token="@INFRASTRUCTURE_MODULE@"
        value="&lt;module id=&quot;EjbModule_InfrastructureModule&quot;&gt;&lt;ejb&gt;coreinf-ejb.jar&lt;/ejb&gt;&lt;/module&gt;"/>
    </replace>

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="weblogic-application.xml"/>
      <replacefilter
        token="@INFRASTRUCTURE_MODULE@"
        value="&lt;module-ref&gt;&lt;module-uri&gt;coreinf-ejb.jar&lt;/module-uri&gt;&lt;/module-ref&gt;"/>
    </replace>

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="ibm-application-ext.xmi"/>
      <replacefilter
        token="@INFRASTRUCTURE_MODULE@"
        value="&lt;moduleExtensions xmi:type=&quot;applicationext:EjbModuleExtension&quot; xmi:id=&quot;EjbModule_InfrastructureModule&quot; altRoot=&quot;ALT-INF/coreinf-ejb.jar&quot;&gt;
    &lt;module xmi:type=&quot;application:EjbModule&quot; href=&quot;META-INF/application.xml#EjbModule_InfrastructureModule&quot;/&gt;
  &lt;/moduleExtensions&gt;"/>
    </replace>

  <!-- Call the mergeShortnames target to ensure that the shortnames get merged and the
     CombinedShortNames.properties file gets created. If the user does not run the
     database target, then the CombinedShortNames.properties may not have been created. -->
  <ant
    antfile="${dir.sde.bin}/build.xml"
    target="mergeshortnames"
    inheritall="false">
    </ant>

    <!-- Generate stubs and skeletons for EJBs -->
    <antcall target="generatewasstub"/>
    <antcall target="generatewlsstub"/>

  </target>

  <!--  *******************************************  -->
  <!--  ***  G E N E R A T E   W L S   S T U B  ***  -->
  <!--  *******************************************  -->
  <!-- Generates stubs and skeletons for EJBs -->
  <target name="generatewlsstub" if="isWLS">

    <copy todir="${dir.ear}" >
      <fileset dir="${prop.file.location}" casesensitive="false">
        <include name="*.properties" />
        <exclude name="*CryptoConfig.properties"/>
        <exclude name="*Shortnames.properties"/>
        <exclude name="Application.properties" />
        <exclude name="AppServer.properties" />
        <exclude name="WebsphereApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="Bootstrap.properties" />
      </fileset>
      <fileset dir="${dir.project.properties}" casesensitive="false">
        <include name="*.properties" />
        <exclude name="*Shortnames.properties"/>
        <exclude name="*CryptoConfig.properties"/>
        <exclude name="Application.properties" />
        <exclude name="AppServer.properties" />
        <exclude name="WebsphereApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="Bootstrap.properties" />
      </fileset>
      <fileset dir="${dir.bld.svr.cls}" casesensitive="false">
        <include name="CombinedShortNames.properties"/>
      </fileset>
    </copy>

    <!-- Include other bootstrap properties. -->
    <antcall target="import.bootstrap.properties">
      <param name="output.file" value="${dir.ear}/Bootstrap.properties"/>
      <param name="extra.arg.1" value="curam.environment.as.vendor=${vendor.name}"/>
      <param name="extra.arg.2" value="#"/>
    </antcall>

    <!-- Create the properties.jar -->
    <jar destfile="${dir.ear.tmp}/properties.jar"
      manifest="${dir.templates}/app-Manifest.mf"
      includes="*.properties"
      basedir="${dir.ear}"/>


    <antcall target="updatewlsjar" inheritall="false">
      <param name="facade" value="InfrastructureModule"/>
    </antcall>
    <antcall target="updatewlsfacadejar" inheritall="false"/>

    <copy toDir="${dir.ear.combined}">
      <fileset dir="${dir.sde.lib}" includes="${sde.lib.list}"/>
      <fileset dir="${dir.sde.lib}" includes="${sde.lib.axis2.list}"/>
      <fileset dir="${dir.sde.lib}" includes="${sde.lib.axis2.rampart.list}"/>
      <fileset dir="${dir.bld.jar}" includes="${app.lib.list}"/>
      <fileset dir="${dir.ear.extrajars}" includes="*.jar"/>
    </copy>

    <copy toDir="${dir.ear.combined}" overwrite="true">
      <fileset dir="${dir.ear.tmp}">
        <include name="*.jar"/>
      </fileset>
    </copy>

  </target>


  <!--  *************************************  -->
  <!--  ***  U P D A T E   W L S   J A R  ***  -->
  <!--  *************************************  -->
  <target name="updatewlsjar">

    <echo message="Creating the ${facade} Enterprise Bean ..."/>
    <copy toDir="${dir.ear.tmp}" file="${jar.coreinf.ejb}"/>

    <!--  *** Substitute with the 'runas.user' property, if specified. Else default to SYSTEM -->
    <unzip src="${dir.ear.tmp}/coreinf-ejb.jar" dest="${dir.ear.tmp}/RunAs">
      <patternset>
        <include name="META-INF/weblogic-ejb-jar.xml"/>
      </patternset>
    </unzip>

    <replace file="${dir.ear.tmp}/RunAs/META-INF/weblogic-ejb-jar.xml"
       token="$RUN_AS_USER_NAME$" value="${runas.user}"/>

    <jar destfile="${dir.ear.tmp}/coreinf-ejb.jar"
      manifest="${dir.ear.tmp}/Manifest.mf"
      update="true">
      <fileset dir="${dir.ear.tmp}/RunAs"/>
    </jar>
    <delete dir="${dir.ear.tmp}/RunAs"/>

  </target>


  <target name="updatewlsfacadejar"
    depends="set.build.facade,-updatewlsfacadejar"/>

  <target name="-updatewlsfacadejar" if="build.facade">

    <echo message="Creating the Application Facade Module ..."/>
    <copy toDir="${dir.ear.tmp}" file="${jar.implementation}"/>

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="application.xml"/>
      <replacefilter
        token="@FACADE_MODULE@"
        value="&lt;module id=&quot;EjbModule_FacadeModule&quot;&gt;&lt;ejb&gt;implementation.jar&lt;/ejb&gt;&lt;/module&gt;"/>
    </replace>

    <replace dir="${dir.ear}/${dd.type}/META-INF">
      <include name="weblogic-application.xml"/>
      <replacefilter
        token="@FACADE_MODULE@"
        value="&lt;module-ref&gt;&lt;module-uri&gt;implementation.jar&lt;/module-uri&gt;&lt;/module-ref&gt;"/>
    </replace>

    <jar destfile="${dir.ear.tmp}/implementation.jar"
      manifest="${dir.ear.tmp}/Manifest.mf"
      update="true"/>

  </target>


  <!--  *******************************************  -->
  <!--  ***  G E N E R A T E   W A S   S T U B  ***  -->
  <!--  *******************************************  -->
  <!-- Generates stubs and skeletons for EJBs -->
  <target name="generatewasstub"  if="isWAS">
    <echo message="Building the component pieces of ${SERVER_MODEL_NAME}.ear..."/>

    <copy todir="${dir.ear}" >
      <fileset dir="${prop.file.location}" casesensitive="false">
        <include name="*.properties" />
        <exclude name="*Shortnames.properties"/>
        <exclude name="*CryptoConfig.properties"/>
        <exclude name="Application.properties" />
        <exclude name="AppServer.properties" />
        <exclude name="WebsphereApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="Bootstrap.properties" />
      </fileset>
      <fileset dir="${dir.project.properties}" casesensitive="false">
        <include name="*.properties" />
        <exclude name="*CryptoConfig.properties"/>
        <exclude name="*Shortnames.properties"/>
        <exclude name="Application.properties" />
        <exclude name="AppServer.properties" />
        <exclude name="WebsphereApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="WLSApplication.properties" />
        <exclude name="Bootstrap.properties" />
      </fileset>
      <fileset dir="${dir.bld.svr.cls}" casesensitive="false">
        <include name="CombinedShortNames.properties"/>
      </fileset>
    </copy>

    <!-- Include other bootstrap properties. -->
    <antcall target="import.bootstrap.properties">
      <param name="output.file" value="${dir.ear}/Bootstrap.properties"/>
      <param name="extra.arg.1" value="curam.environment.as.vendor=${vendor.name}"/>
      <param name="extra.arg.2" value="#"/>
    </antcall>

    <!-- Create the properties.jar -->
    <jar destfile="${dir.ear.tmp}/properties.jar"
      manifest="${dir.templates}/app-Manifest.mf"
      includes="*.properties"
      basedir="${dir.ear}"/>

    <!-- build application bean jar files -->
    <antcall target="updatewlsjar" inheritall="false">
      <param name="facade" value="InfrastructureModule"/>
    </antcall>
    <antcall target="updatewlsfacadejar" inheritall="false"/>

    <!-- Build ear files from existing libraries and bean jar files -->
    <echo message="Creating the ${SERVER_MODEL_NAME}.ear file..."/>

    <copy todir="${dir.ear.combined}">
      <fileset dir="${dir.sde.lib}" includes="${sde.lib.list}"/>
      <fileset dir="${dir.sde.lib}" includes="${sde.lib.axis2.list}"/>
      <fileset dir="${dir.sde.lib}" includes="${sde.lib.axis2.rampart.list}"/>
      <fileset dir="${dir.bld.jar}" includes="${app.lib.list}"/>
      <fileset dir="${dir.ear.extrajars}" includes="*.jar"/>
    </copy>

    <copy toDir="${dir.ear.combined}" overwrite="true">
      <fileset dir="${dir.ear.tmp}">
        <include name="*.jar"/>
      </fileset>
    </copy>

  </target>

  <!-- Print message if AppServer.properties cannot be found. -->
  <target name="check.properties.exists" unless="appserver.properties.exists">
    <fail message="The AppServer.properties file could not be found. (See AppServer.properties.sample.)"/>
  </target>

</project>
