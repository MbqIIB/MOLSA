/*
Copyright IBM Corp. 2010-2013  All Rights Reserved.
*/

(function(){function a(d){var e=d.config.lotusSpellChecker;if(e.service=='XTAF'){this.service=e.service;this.restUrl=e.restUrl+'/'+e.lang+'?'+'suggestions='+e.suggestions+'&autoCorrect=false'+'&text=';this.wordSeparator=' ';e.preventCache=false;this.originalWordKey='word';}else{this.restUrl=e.restUrl+'?delimiter=,&format='+e.format+'&language='+e.lang+'&suggestions='+e.suggestions+'&searchString=';this.wordSeparator=',';this.originalWordKey='originalWord';}this._getCacheParam=(function(){return e.preventCache?function(){return '&timestamp='+new Date().getTime();}:function(){return '';};})();this.maxLength=900;this.words='';this.ignoreWords='';this.misspellings=[];};a.prototype={getFindWordRegExpPattern:function(d){return '(?:^|'+this.wordSeparator+')'+d+'(?='+this.wordSeparator+'|$)';},addWord:function(d){var e=this;if(e.words.length>=e.maxLength)return false;if(!new RegExp(e.getFindWordRegExpPattern(d)).test(e.words))e.words+=d+e.wordSeparator;return true;},addIgnoreWord:function(d){var e=this;if(!new RegExp(e.getFindWordRegExpPattern(d)).test(e.ignoreWords))e.ignoreWords+=d+e.wordSeparator;},removeWords:function(){this.words='';this.misspellings=[];delete this.misspeltWords;},check:function(){var g=this;if(g.words.length>0){if(g.ignoreWords.length>0){var d=new RegExp(g.getFindWordRegExpPattern(g.ignoreWords.replace(/\s*(,| )\s*/g,'|')),'g');g.words=g.words.replace(d,'');}var e=g.restUrl+g.words+g._getCacheParam();try{var f=CKEDITOR.ajax.load(e);if(f===null)return-1;if(typeof JSON!=='undefined'&&JSON.parse)g.misspellings=JSON.parse(f);else g.misspellings=eval('('+f+')');if(g.misspellings&&g.misspellings.result)g.misspellings=g.misspellings.result;if(g.misspellings&&g.misspellings.items)g.misspellings=g.misspellings.items;}catch(h){return-1;}}return g.misspellings.length;},getMisspeltWords:function(){var f=this;if(typeof f.misspeltWords==='undefined'){f.misspeltWords=[];for(var d=0,e=f.misspellings.length;d<e;d++)f.misspeltWords.push(f.misspellings[d][f.originalWordKey]);}return f.misspeltWords;},getSuggestions:function(d){var g=this;for(var e=0,f=g.misspellings.length;e<f;e++){if(g.misspellings[e][g.originalWordKey]===d)return g.misspellings[e];}return[];}};function b(d,e){this.editor=d;this.reset(e);this.nonLetterRegex=/[\^\$\.\*\+\?\=\!\:\|\\\/\(\)\[\]\{\}@#~"£%&_<>0-9]/;};b.prototype={hasText:function(d){return d.type==CKEDITOR.NODE_TEXT&&d.getText().search(/\b/)!=-1;},getContentRange:function(){var d=this.editor.document.getBody(),e=new CKEDITOR.dom.range();
e.setStartAt(d,CKEDITOR.POSITION_AFTER_START);e.setEndAt(d,CKEDITOR.POSITION_AFTER_END);return e;},isWord:function(d){return!this.nonLetterRegex.test(d);},hasNodeMoreWords:function(){var d=this;if(!d.textNode)return false;else return d.end!==d.lastIndex&&d.textNode.getText().substr(d.end).search(/\b/)!==-1;},moveToNextWord:function(){var e=this;if(!e.hasNodeMoreWords())return false;var d=e.textNode.getText();e.start=d.substr(e.end).search(/\b/)+e.end;e.end=d.substr(e.start).search(/[\!'"£#\$%&\(\)\*\+,-\.\/\:;<\=>\?@\[\]\^\_\{\|\}~]*(?=\s)/);if(e.end===-1)e.end=e.lastIndex;else e.end+=e.start;if(e.isWord(e.getWord()))return true;else return e.next();},next:function(){var d=this;if(d.textNode===null)return false;if(!d.moveToNextWord()){d.textNode=d.walker.next.call(d.walker);if(!d.textNode||d.walker._.end)return false;d.lastIndex=d.textNode.getText().search(/\w\W*$/)+1;d.firstIndex=d.textNode.getText().search(/\b/);d.end=d.firstIndex;return d.moveToNextWord();}return true;},getWord:function(){var d=this;if(!d.textNode)return null;else return d.textNode.getText().substring(d.start,d.end);},getCursor:function(){var d=this;return{textNode:d.textNode,start:d.start,end:d.end,word:d.getWord()};},getTraversedRange:function(d){var f=this;var e=new CKEDITOR.dom.range(f.editor.document);e.setStart(f.walker.range.startContainer,f.walker.range.startOffset);if(f.textNode)e.setEnd(f.textNode,d?f.end:f.start);else e.setEnd(f.walker.range.endContainer,f.walker.range.endOffset);return e;},reset:function(d){var e=this;if(typeof d==='undefined')d=e.getContentRange();e.walker=new CKEDITOR.dom.walker(d);e.walker.evaluator=e.hasText;e.walker.breakOnFalse=true;if(e.textNode)delete e.textNode;}};function c(d,e,f){this.editor=d;this.searchWords=e.join(',');this.walker=new b(d,f);this.range=this.walker.walker.range;var g=d.config.lotusSpellChecker;if(typeof g.highlight==='undefined')g.highlight={element:'span',styles:{'background-color':'yellow',color:'black'}};this.highlightStyle=new CKEDITOR.style(CKEDITOR.tools.extend({fullMatch:true,childRule:function(){return false;}},g.highlight));};c.prototype={getWordRange:function(){var d=this.walker.getCursor(),e=new CKEDITOR.dom.range(this.editor.document);e.setStart(d.textNode,d.start);e.setEnd(d.textNode,d.end);return e;},updateWalker:function(d){this.walker.reset(d);this.walker.next();},next:function(){while(this.walker.next()){if(this.searchWords.search(new RegExp('(?:^|,)'+this.walker.getWord()+'(?=,|$)'))!==-1)return true;}return false;
},getWord:function(){return this.walker.getWord();},setEndOffset:function(){var e=this;if(e.range.endContainer.type==CKEDITOR.NODE_TEXT){e.range.endOffset=e.range.endContainer.getLength();return;}for(var d=0;d<e.range.endContainer.getChildCount();d++){if(e.range.endContainer.getChild(d).equals(e.origEndNode)){e.range.endOffset=d;break;}}},getEndNode:function(d){var f=this;if(d)f.setEndOffset();if(f.range.endContainer.type==CKEDITOR.NODE_TEXT)return f.range.endContainer;if(f.range.endContainer.getChildCount()>f.range.endOffset)return f.range.endContainer.getChild(f.range.endOffset);else{var e=f.range.endContainer.getLast();if(0<e.getChildCount())e=e.getLast();return e;}},getOriginalEndNode:function(){this.origEndNode=this.getEndNode(false);},highlight:function(){var h=this;h.removeHighlight();var d=h.getEndNode(true),e=h.getWordRange();h.highlightStyle.applyToRange(e);h.highlightRange=e;var f=e.startContainer;if(f.type!=CKEDITOR.NODE_ELEMENT)f=f.getParent();f.scrollIntoView();var g=new CKEDITOR.dom.range(h.editor.document);g.setStartBefore(e.startContainer.getChild(e.startOffset));g.setEndAfter(d);h.updateWalker(g);},removeHighlight:function(){var d=this;if(d.highlightRange){d.highlightStyle.removeFromRange(d.highlightRange);d.highlightRange=null;}},updateWord:function(d){var i=this;var e=i.getWordRange(),f=i.getEndNode(true),g=i.editor.document.createText(d);e.deleteContents();e.insertNode(g);var h=new CKEDITOR.dom.range(i.editor.document);h.setStartBefore(g);h.setEndAfter(f);i.updateWalker(h);},updateAll:function(d,e){var j=this;var f=j.getWordRange(),g=j.getEndNode(true),h=new c(j.editor,[d]);while(h.next()){h.getOriginalEndNode();h.updateWord(e);}var i=new CKEDITOR.dom.range(j.editor.document);i.setStart(f.startContainer,f.startOffset);i.setEndAfter(g);j.walker.reset(i);}};CKEDITOR.dialog.add('lotusspellchecker',function(d){var e=null,f=null,g=null,h=null;function i(){while(e.next()){if(!f.addWord(e.getWord())){var j=f.check();if(j===0)f.removeWords();else return j;}}return f.check();};return{title:d.lang.ibm.spellchecker.title,minWidth:375,minHeight:160,onLoad:function(){var j=this,k=function(){var l=i();if(l>0){g=new c(d,f.getMisspeltWords(),e.getTraversedRange(false));if(g.next()){g.getOriginalEndNode();j.setupContent(f.getSuggestions(g.getWord()));return;}}else if(l===-1)alert(d.lang.ibm.spellchecker.problem);else{alert(d.lang.ibm.spellchecker.complete);j.getButton('cancel').click();g=null;e=null;spellchecker=null;}};this.moveToNextMisspeltWord=function(){g.removeHighlight();
if(g.next()){this.setupContent(f.getSuggestions(g.getWord()));return;}var l=new CKEDITOR.dom.range(d.document);l.setStartAt(g.getEndNode(true),CKEDITOR.POSITION_BEFORE_START);l.setEndAt(d.document.getBody(),CKEDITOR.POSITION_BEFORE_END);e.reset(l);f.removeWords();k();};this.initialize=function(){e=new b(d);f=new a(d);g=null;k();};},onCancel:function(){if(g)g.removeHighlight();},onHide:function(){this.getContentElement('info','selSuggestion').clear();if(!d.config.disableNativeSpellChecker)d.document.getBody().setAttribute('spellcheck','true');},onShow:function(){if(!d.config.disableNativeSpellChecker)d.document.getBody().setAttribute('spellcheck','false');h=d.getData();d.fire('saveSnapshot');var j=d.document.getBody(),k=new CKEDITOR.dom.range();k.setStartAt(j,CKEDITOR.POSITION_AFTER_START);k.setEndAt(j,CKEDITOR.POSITION_AFTER_END);var l=d.getSelection();if(l)l.unlock();var m=new CKEDITOR.dom.walker(k,d.document);m.evaluator=function(n){return n.type===CKEDITOR.NODE_TEXT;};m.breakOnFalse=false;while(m.next()){if(m.current.getPrevious()&&m.current.getPrevious().type===CKEDITOR.NODE_TEXT){m.current.$.nodeValue=m.current.getPrevious().getText()+m.current.getText();m.current.getPrevious().remove();}}this.initialize();},contents:[{id:'info',title:'Spell Check',padding:0,elements:[{type:'hbox',padding:0,widths:['80%','20%'],children:[{type:'vbox',padding:0,style:d.lang.dir==='ltr'?'margin-right: 10px':'margin-left: 10px',children:[{type:'text',id:'replaceItem',label:d.lang.ibm.spellchecker.replace,isChanged:false,tabIndex:1,setup:function(j){g.highlight();this.setValue(j[f.originalWordKey]);this.focus();}},{type:'text',id:'withItem',label:d.lang.ibm.spellchecker.withLabel,'default':'',isChanged:false,tabIndex:1,setup:function(j){if(j&&j.suggestions&&j.suggestions.length>0)this.setValue(j.suggestions[0]);else this.setValue('');},onChange:function(){var j=this.getDialog().getContentElement('info','replaceButton'),k=this.getDialog().getContentElement('info','replaceallButton');if(this.getValue()==''){j.disable();k.disable();if(j.getElement().getChildCount()>0&&j.getElement().getChild(0).getName()=='span')j.getElement().getChild(0).addClass('cke_disabled');if(k.getElement().getChildCount()>0&&k.getElement().getChild(0).getName()=='span')k.getElement().getChild(0).addClass('cke_disabled');}else{j.enable();k.enable();if(j.getElement().getChildCount()>0&&j.getElement().getChild(0).getName()=='span')j.getElement().getChild(0).removeClass('cke_disabled');if(k.getElement().getChildCount()>0&&k.getElement().getChild(0).getName()=='span')k.getElement().getChild(0).removeClass('cke_disabled');
}}},{type:'select',id:'selSuggestion',items:[],label:d.lang.ibm.spellchecker.suggesstion,isChanged:false,tabIndex:1,size:d.config.lotusSpellChecker.suggestions,style:'width : 100%; height: 100px;',onLoad:function(){if(CKEDITOR.env.ie&&CKEDITOR.env.ie7Compat){var j=parseInt(this.getElement().getStyle('height'),10);this.getElement().getParent().setStyle('height',j+20+'px');}},onChange:function(){if(this.getValue().length>0)this.getDialog().setValueOf('info','withItem',this.getValue());},setup:function(j){var n=this;n.clear();if(!j||!j.suggestions||j.suggestions.length===0){n.disable();return;}n.enable();var k=j.suggestions;for(var l=0,m=k.length;l<m;l++)n.add(k[l]);n.getInputElement().$.options[0].selected='selected';}}]},{type:'vbox',style:'margin-top: 3px',children:[{type:'button',align:'left',style:'display:block;',id:'replaceButton',label:d.lang.ibm.spellchecker.replaceButton,onClick:function(){if(this.getElement().hasClass('cke_disabled'))return;if(!g)return;g.updateWord(this.getDialog().getValueOf('info','withItem'));this.getDialog().moveToNextMisspeltWord();}},{type:'button',align:'left',style:'margin-top:10px;display: block;',id:'replaceallButton',label:d.lang.ibm.spellchecker.replaceallButton,onClick:function(){if(this.getElement().hasClass('cke_disabled'))return;if(!g)return;var j=this.getDialog();g.updateAll(j.getValueOf('info','replaceItem'),j.getValueOf('info','withItem'));j.moveToNextMisspeltWord();}},{type:'button',align:'left',style:'margin-top:10px;display:block;',id:'skipButton',label:d.lang.ibm.spellchecker.skipButton,onClick:function(){if(!g)return;this.getDialog().moveToNextMisspeltWord();}},{type:'button',align:'left',style:'margin-top:10px;display:block;',id:'skipallButton',label:d.lang.ibm.spellchecker.skipallButton,onClick:function(){if(!g)return;var j=this.getDialog(),k=g.getWord();f.addIgnoreWord(k);var l=new RegExp('(?:^|,)(?:'+k+')(?=,|$)','g');g.searchWords=g.searchWords.replace(l,'');j.moveToNextMisspeltWord();}}]}]}]}],buttons:[CKEDITOR.dialog.cancelButton]};});})();
