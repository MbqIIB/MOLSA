/*
Copyright IBM Corp. 2010-2013  All Rights Reserved.
*/

var linkDialog=function(b,c){var d=b.plugins.urllink,e,f=false,g=function(h){var i={},j=h&&(h.data('cke-saved-href')||h.getAttribute('href'))||'',k=/^#(.*)$/,l;f=false;if(l=j.match(k)){f=true;i.anchor={};i.anchor.name=i.anchor.id=l[1];if(h)i.text=h.getText();}else{i.href=j;if(h){i.target=h.getAttribute('target')||'';i.text=h.getText();}}if(c=='bookmark'||f)this.parts.title.setText(b.lang.ibm.anchor.title);else this.parts.title.setText(b.lang.ibm.urllink.title);i.anchors=d.getAnchors(b);this._.selectedElement=h;return i;};return{title:b.lang.ibm.urllink.title,resizable:CKEDITOR.DIALOG_RESIZE_NONE,minWidth:300,minHeight:90,onShow:function(){var h=b.getSelection(),i='';if(h.getType()==CKEDITOR.SELECTION_ELEMENT){var j=h.getSelectedElement();if(j.is('a'))i=j;}if(i==''){var k=h.getRanges();if(k.length!==1)return;k[0].shrink(CKEDITOR.SHRINK_TEXT);var l=k[0].getCommonAncestor(true),i=l.getAscendant('a',true);}this.setupContent(g.apply(this,[i]));var m=this.getContentElement('info','txtDisplay');m.enable();if(i){h.selectElement(i);e=d.findInnerElement(i);if(d.hasChildElementNodes(e)||e instanceof CKEDITOR.dom.element&&e.getName()=='img')m.disable();}else if(!k[0].collapsed){if(d.containsElementNodes(k))m.disable();if(CKEDITOR.env.ie){h.unlock(true);m.setValue(h.getSelectedText());h.lock();}else m.setValue(h.getSelectedText());}},onOk:function(){var l=this;var h={};l.commitContent(h);var i={};if(c=='bookmark'||f){if(h.anchor.name=='')return;i.href='#'+(h.anchor.name||'');i.text=h.text;}else if(c=='urllink'){i.href=h.url;i.target=h.target;i.text=h.text;}if(!l._.selectedElement){i.src='urllink';b.execCommand('insertLink',i);}else{var j=l._.selectedElement;if(i.text){var k=i.text;delete i.text;}if(c=='urllink'&&i.target==''||c=='bookmark'){if(j.hasAttribute('target')&&j.getAttribute('target')==='_blank')j.removeAttribute('target');delete i.target;}if(i.href)i['data-cke-saved-href']=i.href;j.setAttributes(i);if(k&&e)e.setText(k.replace(/ /g,'\xa0'));delete l._.selectedElement;}},contents:[{id:'info',style:'width: 100%',elements:[{type:'select',id:'anchorName','default':'',required:true,label:b.lang.ibm.anchor.linkTo,style:'width: 100%;',items:[['']],setup:function(h){var j=this;if((c=='bookmark'||f)&&h.anchors.length>0)j.getElement().show();else j.getElement().hide();if(h.anchors.length>0){j.clear();for(var i=0;i<h.anchors.length;i++){if(h.anchors[i].name)j.add(h.anchors[i].name);}if(h.anchor)j.setValue(h.anchor.name);}},commit:function(h){if(!h.anchor)h.anchor={};h.anchor.name=this.getValue();
}},{type:'html',id:'noAnchors',style:'text-align: center; white-space: normal;',html:'<div>'+CKEDITOR.tools.htmlEncode(b.lang.link.noAnchors)+'</div>',focus:false,setup:function(h){var j=this;var i=j.getDialog().parts.dialog.getParent();if((c=='bookmark'||f)&&h.anchors.length<1){j.getElement().show();j.getDialog().getContentElement('info','requiredLabel').getElement().hide();i.setAttribute('aria-describedby',j.domId);}else{j.getElement().hide();j.getDialog().getContentElement('info','requiredLabel').getElement().show();if(i.hasAttribute('aria-describedby'))i.removeAttribute('aria-describedby');}}},{id:'txtUrl',type:'text',required:true,'default':'',label:b.lang.common.url,setup:function(h){if(c!='urllink'||f)this.getElement().hide();else this.getElement().show();if(h.href)this.setValue(h.href);},commit:function(h){var i=CKEDITOR.tools.trim(this.getValue());if(!/^([a-zA-Z]+:\/\/|\.|\/|mailto:)/.test(i))i='http://'+i;h.url=i;},validate:function(){var h=this.getDialog();if(c=='bookmark'||f)return true;var i=CKEDITOR.dialog.validate.notEmpty(b.lang.ibm.urllink.nourl);return i.apply(this);}},{id:'txtDisplay',type:'text','default':'',style:'padding: 5px 0px;',label:b.lang.ibm.urllink.linkText,inputStyle:CKEDITOR.env.ie&&CKEDITOR.env.version<9?'width:350px':'',setup:function(h){if((c=='bookmark'||f)&&h.anchors.length<1)this.getElement().hide();else{this.getElement().show();if(h.text)this.setValue(h.text);}},commit:function(h){if(this.isEnabled()){var i=this.getValue();if(c=='urllink')h.text=i!==''?i:h.url;else h.text=i!==''?i:h.anchor.name;}}},{type:'checkbox',id:'chkNewWindow',label:b.lang.ibm.urllink.openinnew,'default':false,setup:function(h){if(c!='urllink'||f)this.getElement().hide();else this.getElement().show();if(h.target)this.setValue(h.target&&h.target==='_blank');},commit:function(h){if(this.getValue())h.target='_blank';else h.target='';}}]}]};};CKEDITOR.dialog.add('urllink',function(b){return linkDialog(b,'urllink');});CKEDITOR.dialog.add('bookmark',function(b){return linkDialog(b,'bookmark');});
